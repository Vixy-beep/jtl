<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tienda JTL — Multi-Tienda (Fullstack)</title>
  
  <style>
:root{
  --bg:#f8fbff;
  --card:#ffffff;
  --muted:#6b7280;
  --accent1:#0ea5a9;
  --accent2:#0369a1;
  --radius:6px;
  --btn-radius:999px;
  --shadow:0 6px 18px rgba(2,6,23,0.06);
  --max-width:1100px;
  font-family:Inter,ui-sans-serif,system-ui;
  color-scheme: light;
}
body.dark{
  --bg:#071024;
  --card:#071a2a;
  --muted:#9aa6b2;
  --accent1:#06b6d4;
  --accent2:#38bdf8;
  --shadow:0 10px 30px rgba(0,0,0,0.6);
  color-scheme: dark;
}

*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#0f172a;}
body.dark{color:#e6eef8}
a{color:inherit;text-decoration:none}
.container{max-width:var(--max-width);margin:28px auto;padding:20px}
header{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.logo{width:56px;height:56px;background:linear-gradient(135deg,var(--accent1),var(--accent2));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px;box-shadow:var(--shadow)}
nav{margin-left:auto;display:flex;gap:6px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:var(--btn-radius);border:none;cursor:pointer;background:var(--accent2);color:white;font-weight:600;white-space:nowrap}
.btn.secondary{background:var(--accent1)}
.topbar{display:flex;gap:12px;align-items:center;margin:18px 0}
.search input{flex:1;padding:10px 14px;border-radius:999px;border:1px solid #e6edf3;background:white;width:100%}
body.dark .search input{background:#052231;border:1px solid rgba(255,255,255,0.06);color:inherit}
.products{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px}
.card img{height:140px;object-fit:cover;border-radius:6px;width:100%}
.price{font-weight:700;color:var(--accent2)}
.badge-cat{display:inline-block;padding:6px 8px;border-radius:999px;background:#eefcfb;color:var(--accent2);font-weight:700;font-size:12px}
body.dark .badge-cat{background:rgba(56,189,248,0.08);color:var(--accent2)}
.sidebar{position:sticky;top:22px}
.cart{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px}
footer{text-align:center;margin-top:20px;color:var(--muted);font-size:13px}
.btn.sm{padding:6px 10px;font-size:13px;border-radius:8px}

#pass-modal, #admin-panel, #block-modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:#00000080;display:none;align-items:center;justify-content:center;
  padding:20px;backdrop-filter:blur(3px);z-index:10000;
}
#pass-modal{align-items:center !important;}
.panel-box{
  background:white;padding:22px 20px;border-radius:12px;
  width:100%;max-width:420px;max-height:85vh;overflow-y:auto;
  box-shadow:var(--shadow);animation:fadeIn .2s ease;
}
body.dark .panel-box{background:var(--card)}
#pass-modal .panel-box{max-width:420px;}
@keyframes fadeIn{from{opacity:0;transform:scale(.96);}to{opacity:1;transform:scale(1);}}
#admin-panel input, #pass-modal input, #admin-panel select{
  border:1px solid #d9e1e7;padding:10px 12px;border-radius:8px;
  font-size:14px;width:100%;margin:6px 0;background:#ffffff;
  transition:.2s;
}
body.dark #admin-panel input, body.dark #pass-modal input, body.dark #admin-panel select{
  background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;
}
#admin-panel input:focus,#pass-modal input:focus,#admin-panel select:focus{
  border-color:var(--accent2);box-shadow:0 0 0 2px rgb(3 105 161 / 25%);outline:none;
}
table{width:100%;font-size:14px;border-collapse:collapse;margin-top:10px;overflow-x:auto;display:block;}
th,td{padding:6px 8px;border-bottom:1px solid #e6edf3;white-space:nowrap;}
body.dark th, body.dark td{border-bottom:1px solid rgba(255,255,255,0.03)}
th{background:#eefcfb;color:var(--accent2);font-weight:600;}
body.dark th{background:rgba(6,182,212,0.06)}
tr:hover td{background:#f1fbff;}
body.dark tr:hover td{background:rgba(255,255,255,0.02);}
tbody{display:table;width:100%;}
thead{display:table;width:100%;}

@media(max-width:768px){
  .sidebar{display:none;}
  #floating-cart-btn{
    position:fixed;bottom:18px;right:18px;background:var(--accent2);
    color:white;padding:14px 20px;border-radius:999px;font-weight:700;
    box-shadow:0 8px 18px rgba(0,0,0,.2);cursor:pointer;z-index:9999;
  }
  #mobile-cart-panel{
    position:fixed;bottom:0;left:0;width:100%;
    background:white;border-radius:16px 16px 0 0;box-shadow:0 -4px 14px rgba(0,0,0,.15);
    padding:18px;display:none;z-index:99999;max-height:85vh;overflow-y:auto;
  }
  body.dark #mobile-cart-panel{background:var(--card)}
  #mobile-cart-close{text-align:center;margin-bottom:12px;padding:6px;
    background:#e8eef5;border-radius:8px;font-weight:600;cursor:pointer;}
  
  /* Modales en móvil */
  #pass-modal, #admin-panel, #block-modal{
    padding:10px;
    align-items:center;
    overflow-y:auto;
  }
  
  #admin-panel{
    align-items:flex-start !important;
  }
  
  .panel-box{
    max-width:100% !important;
    width:100%;
    max-height:none;
    margin:10px 0;
    padding:16px;
    border-radius:12px;
  }
  
  #admin-panel .panel-box{
    margin-top:10px;
    margin-bottom:10px;
  }
  
  /* Tabla responsive */
  table{
    font-size:12px;
    display:block;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  
  th, td{
    padding:8px 6px;
    font-size:12px;
  }
  
  /* Botones en móvil */
  .btn{
    font-size:15px;
    padding:10px 14px;
  }
  
  .btn.sm{
    font-size:13px;
    padding:6px 10px;
  }
  
  /* Inputs en móvil */
  #admin-panel input,
  #admin-panel select,
  #pass-modal input,
  #pass-modal select{
    font-size:16px !important;
    padding:12px;
  }
  
  /* Header responsive */
  header{
    flex-wrap:wrap;
    gap:8px;
  }
  
  .logo{
    width:48px;
    height:48px;
    font-size:18px;
  }
  
  nav{
    gap:8px;
    width:100%;
    justify-content:space-between;
  }
  
  /* Container en móvil */
  .container{
    padding:12px;
    margin:0;
  }
  
  .products{
    grid-template-columns:repeat(2, 1fr);
    gap:12px;
  }
  
  /* Aumentar fuentes generales en móvil */
  body{
    font-size:16px;
  }
  
  .card{
    font-size:15px;
  }
  
  .price{
    font-size:17px;
  }
  
  h3{
    font-size:20px;
  }
  
  h4{
    font-size:18px;
  }
  
  .muted{
    font-size:15px;
  }
  
  .muted-small{
    font-size:14px;
  }
}

/* small helpers */
.muted{color:var(--muted);font-size:13px}
.store-list .row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:#fbfdff}
body.dark .store-list .row{background:rgba(255,255,255,0.02)}
.muted-small{font-size:12px;color:#56616e}
.status-pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#fff6e6;color:#b45309;font-weight:700;font-size:12px}
body.dark .status-pill{background:rgba(255,255,255,0.03)}

/* Subscription card styles */
.sub-card{
  background:linear-gradient(180deg, rgba(6,182,212,0.06), rgba(14,165,166,0.02));
  border-radius:10px;padding:12px;border:1px solid rgba(3,105,161,0.06);
  display:flex;flex-direction:column;gap:6px;margin-bottom:8px;
}
.sub-card h4{margin:0;color:var(--accent2);font-size:16px}
.sub-row{display:flex;justify-content:space-between;align-items:center}
.sub-status{padding:6px 8px;border-radius:999px;font-weight:700;font-size:13px}
.sub-active{background:#ecfeff;color:#0369a1}
.sub-expired{background:#fff1f2;color:#9f1239}
.sub-warning{background:#fff7ed;color:#92400e}
  </style>

</head>
<body>

<div class="container">
  <header>
    <div class="logo">JTL</div>
    <div>
      <p style="margin:0;font-weight:600;color:var(--accent2)" id="header-store-name">Cargando...</p>
      <p style="font-size:12px;margin:0;color:var(--muted)" id="header-store-sub">DeliveryYa • Santiago de los Caballeros</p>
    </div>
    <nav>
      <button class="btn sm" id="theme-toggle" title="Cambiar tema">🌙</button>
      <span id="admin-btn" style="cursor:pointer;font-size:14px;color:var(--accent2);font-weight:600">Admin</span>
      <a class="btn" id="wa-link" target="_blank" style="margin-left:16px;">WhatsApp</a>
    </nav>
  </header>
<main class="layout" style="display:flex;gap:20px;align-items:start">
    <section style="flex:1">
      <!-- Filtros de búsqueda -->
      <div style="display:flex;gap:10px;margin-bottom:16px;align-items:center">
        <select id="filter-category" style="padding:8px 12px;border-radius:8px;border:1px solid #e6edf3;font-size:14px;width:auto;min-width:150px">
          <option value="">Todas las categorías</option>
        </select>
        <input type="text" id="search" placeholder="Buscar..." style="flex:1;padding:8px 12px;border-radius:8px;border:1px solid #e6edf3;font-size:14px">
      </div>
      <div class="products" id="products"></div>
    </section>
    <aside class="sidebar" style="width:320px">
      <div class="cart">
        <strong>Carrito</strong>
        <div id="cart-items"></div>
        <div style="display:flex;justify-content:space-between"><span>Subtotal</span><span id="subtotal">RD$0</span></div>
        <div style="display:flex;justify-content:space-between;font-weight:700"><span>Total</span><span id="total">RD$0</span></div>
        <button class="btn secondary" id="clear-cart">Vaciar</button>
        <button class="btn" id="buy-whatsapp">Comprar por WhatsApp</button>
      </div>
    </aside>
  </main>

  <footer>Diseñado para Tienda JTL — Tema Minimal Moderna</footer>
</div>

<div id="floating-cart-btn">🛒 Carrito</div>
<div id="mobile-cart-panel">
  <div id="mobile-cart-close">Cerrar ✖</div>
  <strong>Carrito</strong>
  <div id="cart-items-mobile"></div>
  <div style="display:flex;justify-content:space-between"><span>Subtotal</span><span id="subtotal-mobile">RD$0</span></div>
  <div style="display:flex;justify-content:space-between;font-weight:700"><span>Total</span><span id="total-mobile">RD$0</span></div>
  <button class="btn secondary" id="clear-cart-mobile">Vaciar</button>
  <button class="btn" id="buy-whatsapp-mobile">Comprar por WhatsApp</button>
</div>

<div id="pass-modal">
  <div class="panel-box">
    <h3>🔐 Acceso — Selecciona la tienda</h3>
    <select id="login-store-select"></select>
    <input id="admin-pass" type="password" placeholder="Contraseña de la tienda...">
    <p id="pass-error" style="color:red;display:none;font-size:13px;margin-top:6px;">Contraseña incorrecta</p>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn" id="pass-enter">Entrar</button>
      <button class="btn secondary" id="pass-cancel">Cancelar</button>
    </div>
    <hr style="margin:12px 0;">
    <p class="muted-small">*Solo la tienda JTL puede crear o eliminar tiendas.*</p>
  </div>
</div>

<div id="block-modal">
  <div class="panel-box" style="text-align:center">
    <h3>🔒 Suscripción vencida</h3>
    <p id="block-msg">La tienda está bloqueada por falta de pago.</p>
    <p class="muted-small">Contacta a JTL para desbloquear la tienda.</p>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
      <button class="btn secondary" id="block-cancel-btn">Cerrar</button>
      <a id="block-wa-btn" class="btn" href="#" target="_blank">Renovar por WhatsApp</a>
    </div>
  </div>
</div>

<div id="admin-panel">
  <div class="panel-box" style="display:flex;flex-direction:column;gap:10px;">
    <h2 style="text-align:center;color:var(--accent2);margin-bottom:6px;">📦 Panel Administrativo — Multi-Tienda</h2>

    <div style="display:flex;gap:8px;align-items:center;">
      <select id="admin-store-selector" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6edf3;"></select>
      <button class="btn sm" id="btn-new-store" style="display:none">+ Nueva</button>
    </div>

    <div id="new-store-box" style="display:none;padding:10px;background:#fbfdff;border-radius:8px;">
      <input id="new-store-name" placeholder="Nombre de la tienda">
      <input id="new-store-wa" placeholder="WhatsApp (ej: 18093108421) - opcional">
      <input id="new-store-pass" placeholder="Contraseña de administrador">
      <div style="display:flex;gap:8px;margin-top:6px;">
        <button class="btn" id="create-store">Crear tienda</button>
        <button class="btn secondary" id="cancel-create">Cancelar</button>
      </div>
    </div>

    <div id="stats" style="padding:10px;margin-bottom:6px;background:#eefcfb;border-radius:8px;">
      <p><strong>Tienda activa:</strong> <span id="stat-store-name">-</span></p>
      <p><strong>Total productos:</strong> <span id="stat-count">0</span></p>
      <p><strong>Unidades en inventario:</strong> <span id="stat-stock">0</span></p>
      <p><strong>Valor total del inventario:</strong> RD$<span id="stat-value">0</span></p>
      <p><strong>Ingresos tienda:</strong> RD$<span id="stat-profit">0</span></p>
      <p><strong>Comisión pendiente para JTL:</strong> RD$<span id="stat-platform">0</span></p>
      <p><strong>Suscripción:</strong> <span id="stat-sub">—</span></p>
      
      <!-- Contador visual de días de suscripción -->
      <div id="subscription-counter" style="margin-top:10px;padding:10px;background:white;border-radius:8px;text-align:center;display:none;">
        <div style="font-size:14px;color:#666;margin-bottom:6px">Días restantes de suscripción</div>
        <div id="days-counter" style="font-size:36px;font-weight:700;color:#10b981">30</div>
        <div style="font-size:12px;color:#999;margin-top:4px">días hasta el vencimiento</div>
      </div>
      
      <button id="reset-profit" style="margin-top:6px;padding:6px 10px;border:none;background:#d9534f;color:white;border-radius:6px;cursor:pointer;">
        Resetear Ganancias
      </button>
    </div>

    <div id="subscription-card-container" style="margin-bottom:6px;display:none;">
      </div>

    <input id="p-name" placeholder="Nombre">
    <input id="p-category" placeholder="Categoría">
    <input id="p-price" placeholder="Precio" type="number" min="0" step="0.01">
    <input id="p-stock" placeholder="Stock" type="number" min="0" step="1">
    <input id="p-img-file" type="file" accept="image/*">
    <button class="btn" id="add-product" style="margin-top:6px;">Guardar Producto</button>

    <table>
      <thead><tr><th>Nombre</th><th>Precio</th><th>Stock</th><th>Cat.</th><th>Acciones</th></tr></thead>
      <tbody id="admin-list"></tbody>
    </table>

    <div style="display:flex;gap:8px;">
      <button class="btn secondary" style="flex:1" id="close-admin">Cerrar</button>
      <button id="delete-all" style="flex:1;padding:10px;border:none;background:#ef4444;color:white;font-weight:700;font-size:16px;border-radius:8px;cursor:pointer;display:none;">
        🗑️ Borrar Mis Datos
      </button>
    </div>

    <hr style="margin:6px 0;">
    <h3 style="color:var(--accent2);text-align:center;">💵 Venta en Efectivo</h3>
    <p class="muted" style="text-align:center;margin-top:-6px;">
      Solo el administrador de la tienda puede registrar pagos en efectivo.
    </p>
    <select id="cash-sale-product" style="width:100%;margin-top:10px;padding:10px;border-radius:8px;border:1px solid #e6edf3;">
      <option value="">Seleccionar producto...</option>
    </select>
    <input id="cash-sale-qty" type="number" placeholder="Cantidad vendida" style="margin-top:6px;" min="1" step="1">
    <input id="cash-sale-paid" type="number" placeholder="Monto recibido (RD$)" style="margin-top:6px;" min="0" step="0.01">
    <button class="btn" id="cash-sale-btn" style="margin-top:10px;width:100%;">Registrar Venta</button>
    <div id="cash-sale-result" style="margin-top:10px;font-weight:600;text-align:center;"></div>

    <hr style="margin:8px 0;">

    <div id="jtl-admin-section" style="display:none;">
      <h4 style="margin:6px 0;color:var(--accent2)">Tiendas (gestionadas por JTL)</h4>
      <div class="store-list" id="store-list"></div>
      <p class="muted">Solo la tienda JTL puede crear/editar/eliminar tiendas.</p>
    </div>

    <hr style="margin:8px 0;">
    <h4>Cambiar contraseña de la tienda actual</h4>
    <input id="change-pass-new" placeholder="Nueva contraseña (mín 6 caracteres)">
    <div style="display:flex;gap:8px;">
      <button class="btn" id="change-pass-btn">Cambiar contraseña</button>
      <button class="btn secondary" id="toggle-public-btn" style="display:none;">Alternar pública/privada</button>
    </div>

    <div style="margin-top:10px;">
      <div id="monthly-control" style="display:none;margin-top:6px;">
        <label style="font-weight:700;margin-bottom:6px;display:block;">Monto mensual (RD$)</label>
        <input id="monthly-input" placeholder="RD$500" type="number">
        <button class="btn" id="save-monthly-btn" style="margin-top:6px;">Guardar monto mensual</button>
      </div>

      <div style="margin-top:8px;">
        <button class="btn" id="register-pay-btn" style="width:100%;display:none;">Registrar pago mensual (+30 días)</button>
      </div>
    </div>

  </div>
</div>

<script>
// --- ¡INICIO DE LA CORRECCIÓN! ---
// Espera a que el HTML esté completamente cargado antes de ejecutar el script
document.addEventListener('DOMContentLoaded', () => {

/* ----------------- MULTI-TIENDA FULLSTACK (CLIENTE) ----------------- */

// --- Variables Globales ---
const THEME_KEY = 'jt_theme_v2';
const API_URL = 'https://jtl-tienda-api-v2.onrender.com'; // URL de Render

// Estado de la aplicación
let ALL_STORES = []; 
let ACTIVE_STORE = null; 
let LOGGED_IN_STORE = null; 
let products = []; 
let cart = [];

// --- Helpers de Autenticación ---
function getToken(){ return localStorage.getItem('authToken'); }
function saveToken(token){ localStorage.setItem('authToken', token); }
function removeToken(){ localStorage.removeItem('authToken'); }
function getAuthHeaders(){
  return {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + getToken()
  };
}

/* ---------- helpers ---------- */
function formatRD(value){ return 'RD$' + Number(value).toFixed(2); }
function daysUntil(msStr){ 
  if (!msStr) return 0;
  const ms = new Date(msStr).getTime();
  return Math.max(0, Math.ceil((ms - Date.now()) / (24*60*60*1000))); 
}

// Función para redimensionar y comprimir imagen
async function processImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        // Crear canvas para redimensionar
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Calcular nuevas dimensiones (máximo 800px de ancho)
        let width = img.width;
        let height = img.height;
        const maxWidth = 800;
        
        if (width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        // Dibujar imagen redimensionada
        ctx.drawImage(img, 0, 0, width, height);
        
        // Convertir a base64 con compresión (calidad 0.8)
        const base64 = canvas.toDataURL('image/jpeg', 0.8);
        resolve(base64);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ---------- DOM ---------- */
const productsWrap = document.getElementById('products');
const cartItems = document.getElementById('cart-items');
const subtotalEl = document.getElementById('subtotal');
const totalEl = document.getElementById('total');
const mobileCartPanel = document.getElementById('mobile-cart-panel');
const floatingCartBtn = document.getElementById('floating-cart-btn');
const adminBtn = document.getElementById('admin-btn');
const passModal = document.getElementById('pass-modal');
const adminPanel = document.getElementById('admin-panel');
const passError = document.getElementById('pass-error');
const pName = document.getElementById('p-name');
const pCategory = document.getElementById('p-category');
const pPrice = document.getElementById('p-price');
const pStock = document.getElementById('p-stock');
const pImgFile = document.getElementById('p-img-file');
const statCount = document.getElementById('stat-count');
const statStock = document.getElementById('stat-stock');
const statValue = document.getElementById('stat-value');
const statProfit = document.getElementById('stat-profit');
const statPlatform = document.getElementById('stat-platform');
const statStoreName = document.getElementById('stat-store-name');
const statSub = document.getElementById('stat-sub');
const filterCategory = document.getElementById('filter-category');
const searchInput = document.getElementById('search');
const adminStoreSelector = document.getElementById('admin-store-selector');
const btnNewStore = document.getElementById('btn-new-store');
const newStoreBox = document.getElementById('new-store-box');
const newStoreName = document.getElementById('new-store-name');
const newStoreWa = document.getElementById('new-store-wa');
const newStorePass = document.getElementById('new-store-pass');
const createStoreBtn = document.getElementById('create-store');
const cancelCreateBtn = document.getElementById('cancel-create');
const adminListTbody = document.getElementById('admin-list');
const cashSelect = document.getElementById('cash-sale-product');
const cashQty = document.getElementById('cash-sale-qty');
const cashPaid = document.getElementById('cash-sale-paid');
const cashResult = document.getElementById('cash-sale-result');
const storeListDiv = document.getElementById('store-list');
const headerStoreName = document.getElementById('header-store-name');
const headerStoreSub = document.getElementById('header-store-sub');
const waLink = document.getElementById('wa-link');
const loginStoreSelect = document.getElementById('login-store-select');
const loginPassInput = document.getElementById('admin-pass');
const passEnterBtn = document.getElementById('pass-enter');
const passCancelBtn = document.getElementById('pass-cancel');
const blockModal = document.getElementById('block-modal');
const blockCancelBtn = document.getElementById('block-cancel-btn');
const blockMsg = document.getElementById('block-msg');
const blockWaBtn = document.getElementById('block-wa-btn');
const changePassInput = document.getElementById('change-pass-new');
const changePassBtn = document.getElementById('change-pass-btn');
const togglePublicBtn = document.getElementById('toggle-public-btn');
const markPaidBtn = document.getElementById('register-pay-btn');
const monthlyControlDiv = document.getElementById('monthly-control');
const monthlyInput = document.getElementById('monthly-input');
const saveMonthlyBtn = document.getElementById('save-monthly-btn');
const themeToggle = document.getElementById('theme-toggle');
const subscriptionCardContainer = document.getElementById('subscription-card-container');
const resetProfitBtn = document.getElementById('reset-profit');
const jtlAdminSection = document.getElementById('jtl-admin-section');
const deleteAllDataBtn = document.getElementById('delete-all');

/* ---------- Header / WA / Theme ---------- */
function renderHeader(){
  if (!ACTIVE_STORE) return;
  headerStoreName.textContent = ACTIVE_STORE.name;
  headerStoreSub.textContent = `DeliveryYa • Santiago de los Caballeros`;
  waLink.href = `https://wa.me/${ACTIVE_STORE.whatsapp || '18093108421'}`;
}

function applyThemeFromStorage(){
  const t = localStorage.getItem(THEME_KEY) || 'light';
  if(t === 'dark') document.body.classList.add('dark');
  else document.body.classList.remove('dark');
  themeToggle.textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
}
themeToggle.onclick = () => {
  document.body.classList.toggle('dark');
  const now = document.body.classList.contains('dark') ? 'dark' : 'light';
  localStorage.setItem(THEME_KEY, now);
  themeToggle.textContent = now === 'dark' ? '☀️' : '🌙';
};

/* ---------- Productos / UI (Pública) ---------- */

async function loadProductsFor(storeId) {
  try {
    const response = await fetch(`${API_URL}/api/products/${storeId}`);
    if (!response.ok) {
      console.error('Error del servidor:', response.status);
      return [];
    }
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('No se pudo conectar al servidor:', error);
    return []; 
  }
}

async function renderStats(storeId) {
  try {
    const response = await fetch(`${API_URL}/api/stats/${storeId}`, { headers: getAuthHeaders() });
    if (!response.ok) {
        const err = await response.json();
        throw new Error(err.message || 'No se pudieron cargar las estadísticas');
    }
    const stats = await response.json();
    
    const c = products.length;
    const u = products.reduce((a,b)=>a+(b.stock||0),0);
    const v = products.reduce((a,b)=>a + ((b.stock||0) * (Number(b.price)||0)), 0);
    
    statCount.textContent = c;
    statStock.textContent = u;
    statValue.textContent = v.toFixed(2);
    statProfit.textContent = (stats.totalRevenue || 0).toFixed(2);
    statPlatform.textContent = (stats.platformFeeOwed || 0).toFixed(2);
    statStoreName.textContent = stats.name || '-';

    const days = daysUntil(stats.subscriptionPaidUntil);
    statSub.textContent = days > 0 ? `Activa — vence en ${days} días` : 'Vencida — bloqueada';
    
    // Actualizar contador visual
    const subscriptionCounter = document.getElementById('subscription-counter');
    const daysCounter = document.getElementById('days-counter');
    
    if (stats.name !== 'jtl') {
      subscriptionCounter.style.display = 'block';
      daysCounter.textContent = days;
      
      // Cambiar color según días restantes
      if (days > 15) {
        daysCounter.style.color = '#10b981'; // Verde
      } else if (days > 7) {
        daysCounter.style.color = '#f59e0b'; // Amarillo
      } else if (days > 0) {
        daysCounter.style.color = '#ef4444'; // Rojo
      } else {
        daysCounter.style.color = '#991b1b'; // Rojo oscuro
        daysCounter.textContent = '0';
      }
    } else {
      subscriptionCounter.style.display = 'none';
    }
    
  } catch (error) {
    console.error('Error renderStats:', error.message);
    if (error.message.includes('Suscripción vencida')) {
        showBlockModal(LOGGED_IN_STORE.name);
    }
    statProfit.textContent = 'Error';
    statPlatform.textContent = 'Error';
  }
}

function loadCategoryFilter(){
  const cats = [...new Set(products.map(p => p.category || 'General'))];
  filterCategory.innerHTML = `<option value="">Todas</option>` + cats.map(c => `<option value="${c.toLowerCase()}">${c}</option>`).join('');
}

function renderProducts(filterText = ''){
  productsWrap.innerHTML = '';
  const cat = filterCategory.value.toLowerCase() || '';
  const ft = filterText.toLowerCase();
  const list = products.filter(p => {
    const n = (p.name||'').toLowerCase();
    const c = (p.category||'general').toLowerCase();
    return (n.includes(ft) || c.includes(ft)) && (cat === '' || c === cat);
  });

  if(list.length === 0){
    productsWrap.innerHTML = '<p>No hay productos</p>';
    return;
  }

  list.forEach(p => {
    const s = p.stock > 1 ? `<small>Stock: ${p.stock}</small>` : p.stock === 1 ? `<small style="color:#f97316">🔔 Última unidad</small>` : `<small style="color:red">Agotado</small>`;
    const card = document.createElement('div');
    card.className = 'card';
    // Usar imagen del producto o una imagen por defecto en base64
    const img = p.img || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23ddd" width="400" height="300"/%3E%3Ctext fill="%23999" font-family="sans-serif" font-size="24" text-anchor="middle" x="200" y="150"%3ESin Imagen%3C/text%3E%3C/svg%3E';
    
    // Encontrar la tienda del producto
    const productStore = ALL_STORES.find(store => store._id === p.store);
    const storeName = productStore ? productStore.name : 'Tienda';
    const storeWhatsApp = productStore ? (productStore.whatsapp || '18093108421') : '18093108421';
    
    card.innerHTML = `
      <img src="${img}" alt="${p.name}">
      <h4 style="margin:6px 0 0 0">${p.name}</h4>
      <p style="font-size:11px;color:var(--muted);margin:4px 0">📍 ${storeName}</p>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
        <span class="price">${formatRD(p.price)}</span><span class="badge-cat">${p.category||'General'}</span>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        ${s}
        <div>
          <button class="btn sm secondary" ${p.stock<=0?'disabled':''} data-add="${p._id}">Añadir</button>
          <button class="btn sm" style="margin-left:6px" data-wa="${p._id}" data-store-wa="${storeWhatsApp}">Pedir</button>
        </div>
      </div>
    `;
    productsWrap.appendChild(card);
  });

  productsWrap.querySelectorAll('[data-add]').forEach(btn => {
    btn.onclick = () => addToCart(btn.getAttribute('data-add'));
  });
  productsWrap.querySelectorAll('[data-wa]').forEach(btn => {
    btn.onclick = () => {
      const pid = btn.getAttribute('data-wa');
      const storeWA = btn.getAttribute('data-store-wa');
      const p = products.find(x=>x._id===pid);
      if(!p) return;
      const productStore = ALL_STORES.find(store => store._id === p.store);
      const storeName = productStore ? productStore.name : 'la tienda';
      const msg = encodeURIComponent(`Hola, quiero pedir: *${p.name}* — ${formatRD(p.price)} desde *${storeName}*`);
      window.open(`https://wa.me/${storeWA}?text=${msg}`, '_blank');
    };
  });
}

function renderCart(){
  const cont = [
    { w: cartItems, s: subtotalEl, t: totalEl },
    { w: document.getElementById('cart-items-mobile'), s: document.getElementById('subtotal-mobile'), t: document.getElementById('total-mobile') }
  ];
  cont.forEach(c => c.w.innerHTML = '');
  let sub = 0;
  cart.forEach(it => {
    const p = products.find(x => x._id === it.productId);
    if(!p) return;
    const line = document.createElement('div');
    line.style.marginBottom = '8px';
    line.innerHTML = `${p.name} x${it.qty} <span style="float:right">${formatRD(p.price * it.qty)}</span>`;
    cont.forEach(c => c.w.appendChild(line.cloneNode(true)));
    sub += p.price * it.qty;
  });
  cont.forEach(c => { c.s.textContent = formatRD(sub); c.t.textContent = formatRD(sub); });
}

function addToCart(productId){
  const p = products.find(x => x._id === productId);
  if(!p) return alert('Producto no encontrado');
  if(p.stock <= 0) return alert('Sin stock');
  const ex = cart.find(c => c.productId === productId);
  if(ex){
    if(ex.qty < p.stock) ex.qty++;
    else return alert('Stock insuficiente');
  } else {
    cart.push({ productId: productId, qty: 1 });
  }
  renderCart();
}

/* ---------- carrito botones ---------- */
document.getElementById('clear-cart').onclick = () => { cart = []; renderCart(); };
document.getElementById('clear-cart-mobile').onclick = () => { cart = []; renderCart(); mobileCartPanel.style.display = 'none'; };

document.getElementById('buy-whatsapp').onclick = buyWhatsAppHandler;
document.getElementById('buy-whatsapp-mobile').onclick = () => { buyWhatsAppHandler(); mobileCartPanel.style.display = 'none'; };

async function buyWhatsAppHandler(){
  if(cart.length === 0) return alert('Carrito vacío');
  
  // Agrupar productos por tienda
  const productsByStore = {};
  cart.forEach(item => {
    const product = products.find(p => p._id === item.productId);
    if (!product) return;
    
    const storeId = product.store;
    if (!productsByStore[storeId]) {
      productsByStore[storeId] = [];
    }
    productsByStore[storeId].push({ product, qty: item.qty });
  });
  
  // Verificar que todas las tiendas tengan suscripción activa
  for (const storeId in productsByStore) {
    const store = ALL_STORES.find(s => s._id === storeId);
    if (!store) continue;
    
    const days = daysUntil(store.subscriptionPaidUntil);
    if(days <= 0 && store.name !== 'jtl') {
      showBlockModal(store.name);
      return alert(`La tienda "${store.name}" tiene la suscripción vencida. No se puede procesar el pedido.`);
    }
  }
  
  try {
    const response = await fetch(`${API_URL}/api/sales/whatsapp`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cart: cart, storeId: ACTIVE_STORE._id })
    });

    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.message || 'Error al procesar la venta');
    }

    // Enviar mensaje a cada tienda por separado
    for (const storeId in productsByStore) {
      const store = ALL_STORES.find(s => s._id === storeId);
      if (!store) continue;
      
      const storeProducts = productsByStore[storeId];
      let total = 0;
      let msg = `🛍 *Pedido para ${store.name}*%0A%0A`;
      
      storeProducts.forEach(({ product, qty }) => {
        total += product.price * qty;
        msg += `• ${product.name} x${qty} - RD$${(product.price * qty).toFixed(2)}%0A`;
      });

      msg += `%0A💰 *Total:* RD$${total.toFixed(2)}%0A%0A🚚 *DeliveryYa — Santiago*%0A%0A¿Dirección para entregar?`;
      const storeWA = store.whatsapp || '18093108421';
      const wa = `https://wa.me/${storeWA}?text=${msg}`;
      window.open(wa, '_blank');
    }

    cart = [];
    
    // Recargar productos de todas las tiendas
    products = [];
    for (const store of ALL_STORES) {
      const storeProducts = await loadProductsFor(store._id);
      products.push(...storeProducts);
    }
    
    renderProducts();
    renderCart();
  } catch (error) {
    console.error('Error en buyWhatsAppHandler:', error);
    alert('Error al procesar el pedido: ' + error.message);
  }
}

/* ---------- LOGIN ADMIN: ahora por tienda (con bloqueo) ---------- */
adminBtn.onclick = () => {
  passError.style.display = 'none';
  loginPassInput.value = '';
  passModal.style.display = 'flex';
};

function populateLoginStores(){
  loginStoreSelect.innerHTML = ALL_STORES.map(s => `<option value="${s._id}">${s.name} ${s.isPublic ? '( pública )' : '( privada )'}</option>`).join('');
}

passEnterBtn.onclick = async () => {
  const storeId = loginStoreSelect.value;
  const password = loginPassInput.value || '';
  passError.style.display = 'none';

  try {
    const response = await fetch(`${API_URL}/api/stores/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ storeId: storeId, password: password })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.message || 'Contraseña incorrecta');

    saveToken(data.token);
    LOGGED_IN_STORE = data.store;
    
    passModal.style.display = 'none';
    loginPassInput.value = '';
    adminPanel.style.display = 'flex';
    
    await initAdminUI(LOGGED_IN_STORE);
    
  } catch (error) {
    console.error('Error de login:', error);
    passError.textContent = error.message;
    passError.style.display = 'block';
  }
};

passCancelBtn.onclick = () => { passModal.style.display = 'none'; passError.style.display = 'none'; };

function showBlockModal(storeName){
    blockMsg.textContent = `La tienda "${storeName}" está bloqueada porque la suscripción venció.`;
    blockWaBtn.href = `https://wa.me/18093108421?text=${encodeURIComponent('Hola, necesito renovar la suscripción de la tienda "'+storeName+'"')}`;
    blockModal.style.display = 'flex';
    blockCancelBtn.onclick = () => blockModal.style.display = 'none';
}

/* ---------- Admin panel (inicializar con tienda específica) ---------- */
async function initAdminUI(store){
  adminStoreSelector.innerHTML = ALL_STORES.map(s => `<option value="${s._id}">${s.name}</option>`).join('');
  adminStoreSelector.value = store._id;

  if (store.name !== 'jtl') {
    adminStoreSelector.disabled = true;
  } else {
    adminStoreSelector.disabled = false;
  }

  await loadAdminDataForStore(store._id);

  adminStoreSelector.onchange = async () => {
    const selectedStoreId = adminStoreSelector.value;
    await loadAdminDataForStore(selectedStoreId);
  };
}

async function loadAdminDataForStore(storeId) {
  try {
    products = await loadProductsFor(storeId);
    await renderStats(storeId);
    await loadAdminList();
    await loadCashSelect();
    renderStoreList(); 
    renderAdminControlsVisibility();
  } catch (error) {
    console.error('Error al cargar datos de admin:', error);
    alert('Error al cargar datos del admin: ' + error.message);
  }
}

/* ---------- Lista admin y acciones de tiendas (JTL) ---------- */
function renderStoreList(){
  if (!LOGGED_IN_STORE || LOGGED_IN_STORE.name !== 'jtl') {
    jtlAdminSection.style.display = 'none';
    return;
  }
  jtlAdminSection.style.display = 'block';
  
  storeListDiv.innerHTML = '';
  ALL_STORES.forEach(s => {
    const row = document.createElement('div');
    row.className = 'row';
    const days = daysUntil(s.subscriptionPaidUntil);
    const subActive = days > 0;
    const whatsappDisplay = s.whatsapp ? `📱 ${s.whatsapp}` : '📱 Sin WhatsApp';
    
    row.innerHTML = `
      <div>
        <div style="font-weight:700">${s.name}${s.name ==='jtl' ? ' — (Principal)' : ''}</div>
        <div class="muted" style="font-size:12px">${whatsappDisplay}</div>
        <div style="margin-top:4px">${subActive ? `<span class="status-pill">Activa (${days} días)</span>` : '<span class="status-pill">Suscripción vencida</span>'}</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn sm" data-make="${s._id}" data-public="${s.isPublic}">${s.isPublic ? 'Pública' : 'Privada'}</button>
        <button class="btn sm" data-pay="${s._id}">+30 Días</button>
        <button class="btn sm" data-del="${s._id}" style="background:#ef4444" ${s.name === 'jtl' ? 'disabled' : ''}>Eliminar</button>
      </div>
    `;
    storeListDiv.appendChild(row);
  });

  // Manejadores (Arregla el bug DOCTYPE)
  storeListDiv.querySelectorAll('[data-make]').forEach(b => {
    b.onclick = async () => {
      const id = b.getAttribute('data-make');
      const isCurrentlyPublic = b.getAttribute('data-public') === 'true';
      if (!confirm(`¿Desea hacer esta tienda ${isCurrentlyPublic ? 'PRIVADA' : 'PÚBLICA'}?`)) return;
      try {
        const response = await fetch(`${API_URL}/api/stores/${id}/public`, {
          method: 'PUT',
          headers: getAuthHeaders(),
          body: JSON.stringify({ isPublic: !isCurrentlyPublic })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        alert('Estado de la tienda actualizado.');
        ALL_STORES = await (await fetch(`${API_URL}/api/stores`)).json();
        renderStoreList();
      } catch (error) { alert('Error: ' + error.message); }
    };
  });

  storeListDiv.querySelectorAll('[data-pay]').forEach(b => {
    b.onclick = async () => {
      const id = b.getAttribute('data-pay');
      if (!confirm(`¿Registrar pago de 30 días para esta tienda?`)) return;
      try {
        const response = await fetch(`${API_URL}/api/stores/${id}/pay`, {
          method: 'PUT',
          headers: getAuthHeaders()
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        alert('Pago registrado. La suscripción ha sido extendida.');
        ALL_STORES = await (await fetch(`${API_URL}/api/stores`)).json();
        renderStoreList();
        await renderStats(adminStoreSelector.value);
      } catch (error) { alert('Error: ' + error.message); }
    };
  });

  storeListDiv.querySelectorAll('[data-del]').forEach(b => {
    b.onclick = async () => {
      const id = b.getAttribute('data-del');
      if (!confirm('¿ELIMINAR esta tienda y TODOS sus productos? Esta acción es irreversible.')) return;
      try {
        const response = await fetch(`${API_URL}/api/stores/${id}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        alert('Tienda eliminada.');
        ALL_STORES = await (await fetch(`${API_URL}/api/stores`)).json();
        populateLoginStores();
        renderStoreList();
      } catch (error) { alert('Error: ' + error.message); }
    };
  });
}

/* ---------- Admin: lista productos y acciones ---------- */
async function loadAdminList(){
  adminListTbody.innerHTML = '';
  const list = products;
  list.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.name}</td><td>${formatRD(p.price)}</td><td>${p.stock}</td><td>${p.category||'General'}</td>
      <td>
        <button class="btn sm" data-del="${p._id}">Eliminar</button>
      </td>`;
    adminListTbody.appendChild(tr);
  });
  
  adminListTbody.querySelectorAll('[data-del]').forEach(b => {
    b.onclick = async () => {
      const productId = b.getAttribute('data-del');
      if (!confirm('¿Seguro que quieres eliminar este producto?')) return;
      try {
        const response = await fetch(`${API_URL}/api/products/${productId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        alert('¡Producto eliminado!');
        await loadAdminDataForStore(adminStoreSelector.value);
      } catch (error) {
        console.error('Error al eliminar:', error);
        alert('Error al eliminar: ' + error.message);
      }
    };
  });
}

document.getElementById('add-product').onclick = async () => {
  const name = pName.value.trim();
  const category = pCategory.value.trim() || 'General';
  const price = Number(pPrice.value) || 0;
  const stock = Number(pStock.value) || 0;
  
  if (!name) {
    return alert('El nombre del producto es requerido');
  }
  
  // Procesar imagen si existe
  let imgData = '';
  if (pImgFile.files && pImgFile.files[0]) {
    const file = pImgFile.files[0];
    
    // Validar que sea una imagen
    if (!file.type.startsWith('image/')) {
      return alert('Por favor selecciona un archivo de imagen válido');
    }
    
    // Validar tamaño (máximo 5MB antes de procesar)
    if (file.size > 5 * 1024 * 1024) {
      return alert('La imagen es muy grande. Máximo 5MB');
    }
    
    // Mostrar mensaje de procesamiento
    const btnAddProduct = document.getElementById('add-product');
    const originalText = btnAddProduct.textContent;
    btnAddProduct.textContent = 'Procesando imagen...';
    btnAddProduct.disabled = true;
    
    // Procesar y comprimir imagen
    try {
      imgData = await processImage(file);
      console.log('Imagen procesada, tamaño:', Math.round(imgData.length / 1024), 'KB');
    } catch (error) {
      btnAddProduct.textContent = originalText;
      btnAddProduct.disabled = false;
      console.error('Error al procesar imagen:', error);
      return alert('Error al procesar la imagen. Intenta con otra imagen.');
    }
    
    btnAddProduct.textContent = originalText;
    btnAddProduct.disabled = false;
  }

  try {
    const response = await fetch(`${API_URL}/api/products`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ name, category, price, stock, img: imgData })
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.message);
    
    alert('¡Producto guardado en la base de datos!');
    pName.value = pCategory.value = pPrice.value = pStock.value = '';
    pImgFile.value = '';
    await loadAdminDataForStore(adminStoreSelector.value);
  } catch (error) {
    console.error('Error al guardar:', error);
    alert('Error al guardar: ' + error.message);
  }
};

/* ---------- Venta en efectivo (con comisión) ---------- */
async function loadCashSelect(){
  const list = products;
  cashSelect.innerHTML = '<option value="">Seleccionar producto...</option>' + list.map(p => `<option value="${p._id}">${p.name} — ${formatRD(p.price)}</option>`).join('');
}

document.getElementById('cash-sale-btn').onclick = async () => { 
  const productId = cashSelect.value;
  const quantity = Number(cashQty.value) || 0;
  const paidAmount = Number(cashPaid.value) || 0;
  cashResult.textContent = '';

  try {
    const response = await fetch(`${API_URL}/api/sales/cash`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ productId, quantity, paidAmount })
    });
    
    const data = await response.json();
    if (!response.ok) throw new Error(data.message);

    cashResult.textContent = data.message;
    cashQty.value = '';
    cashPaid.value = '';
    
    await loadAdminDataForStore(adminStoreSelector.value);

  } catch (error) {
    console.error('Error en Venta en Efectivo:', error);
    cashResult.textContent = 'Error: ' + error.message;
  }
};

/* ---------- Filtros y búsqueda ---------- */
// --- ¡CORRECCIÓN FINAL! ---
// Movemos estos listeners aquí, después de que las variables están definidas
filterCategory.onchange = () => renderProducts(searchInput.value);
searchInput.oninput = () => renderProducts(searchInput.value);

/* ---------- Panel y carrito móviles ---------- */
floatingCartBtn.onclick = () => { mobileCartPanel.style.display = 'block'; };
document.getElementById('mobile-cart-close').onclick = () => {
  mobileCartPanel.style.display = 'none';
};
// --- FIN DE LA CORRECCIÓN ---

/* ---------- Controles de Admin (Crear Tienda, Cambiar Pass, etc.) ---------- */
btnNewStore.onclick = () => { newStoreBox.style.display = newStoreBox.style.display === 'none' ? 'block' : 'none'; };
cancelCreateBtn.onclick = () => { newStoreBox.style.display = 'none'; newStoreName.value = newStoreWa.value = newStorePass.value = ''; };

createStoreBtn.onclick = async () => {
  const name = newStoreName.value.trim();
  const whatsapp = newStoreWa.value.trim();
  const password = newStorePass.value.trim();
  if (!name || !password) return alert('Nombre y contraseña requeridos');
  try {
    const response = await fetch(`${API_URL}/api/stores`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ name, whatsapp, password, isPublic: false })
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.message);
    
    alert('Tienda creada con éxito.');
    newStoreBox.style.display = 'none';
    newStoreName.value = newStoreWa.value = newStorePass.value = '';
    
    ALL_STORES = await (await fetch(`${API_URL}/api/stores`)).json();
    populateLoginStores();
    renderStoreList();
  } catch (error) { alert('Error: ' + error.message); }
};

changePassBtn.onclick = async () => {
  const newPassword = (changePassInput.value || '').trim();
  if (!newPassword || newPassword.length < 6) return alert('La contraseña debe tener al menos 6 caracteres');
  if (!confirm('¿Seguro que quieres cambiar tu contraseña?')) return;
  try {
    const response = await fetch(`${API_URL}/api/stores/password`, {
      method: 'PUT',
      headers: getAuthHeaders(),
      body: JSON.stringify({ newPassword })
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.message);
    
    changePassInput.value = '';
    alert('Contraseña actualizada con éxito.');
  } catch (error) { alert('Error: ' + error.message); }
};

togglePublicBtn.onclick = () => {
  const selectedStoreId = adminStoreSelector.value;
  const store = ALL_STORES.find(s => s._id === selectedStoreId);
  if (!store) return;
  const btn = storeListDiv.querySelector(`[data-make="${selectedStoreId}"]`);
  if (btn) btn.click();
};

resetProfitBtn.onclick = async () => {
  if (!confirm('¿Seguro que desea resetear las ganancias y comisiones de esta tienda?')) return;
  try {
    const response = await fetch(`${API_URL}/api/stores/resetprofit`, {
      method: 'POST',
      headers: getAuthHeaders()
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.message);
    
    alert('Ganancias y comisiones reseteadas.');
    await renderStats(LOGGED_IN_STORE._id);
  } catch (error) { alert('Error: ' + error.message); }
};

deleteAllDataBtn.onclick = async () => {
  if (LOGGED_IN_STORE.name === 'jtl') return alert('JTL no puede usar esta función.');
  if (!confirm('¿Seguro que quieres borrar TODOS tus productos y datos de ganancias? Esta acción es irreversible.')) return;
  try {
    const response = await fetch(`${API_URL}/api/stores/my-data`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.message);
    
    alert(data.message);
    await loadAdminDataForStore(LOGGED_IN_STORE._id);
  } catch (error) { alert('Error: ' + error.message); }
};

saveMonthlyBtn.onclick = async () => {
    const value = Number(monthlyInput.value);
    if (!value || value <= 0) return alert('Monto inválido');
    try {
        const response = await fetch(`${API_URL}/api/settings/monthly_amount`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify({ value: value })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        alert('Monto mensual actualizado: RD$' + data.value.toFixed(2));
    } catch (error) { alert('Error: ' + error.message); }
};

async function loadMonthlyAmount() {
    try {
        const response = await fetch(`${API_URL}/api/settings/monthly_amount`, { headers: getAuthHeaders() });
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        monthlyInput.value = data.value;
    } catch (error) { console.error('Error cargando monto mensual', error); }
}

/* mostrar/ocultar controles JTL segun sesión */
function renderAdminControlsVisibility(){
  if (LOGGED_IN_STORE.name !== 'jtl') {
    // Tiendas normales (NO JTL)
    jtlAdminSection.style.display = 'none';
    togglePublicBtn.style.display = 'none';
    btnNewStore.style.display = 'none';
    monthlyControlDiv.style.display = 'none';
    deleteAllDataBtn.style.display = 'block'; // Mostrar botón de borrar datos
  } else {
    // Tienda JTL (administrador principal)
    jtlAdminSection.style.display = 'block';
    togglePublicBtn.style.display = 'inline-flex';
    btnNewStore.style.display = 'inline-flex';
    monthlyControlDiv.style.display = 'block';
    deleteAllDataBtn.style.display = 'none'; // Ocultar botón de borrar datos para JTL
    loadMonthlyAmount();
  }
}

/* ---------- Inicialización pública (vista cliente) ---------- */
async function initPublicUI(){
  try {
    const response = await fetch(`${API_URL}/api/stores`);
    if (!response.ok) {
        const errData = await response.text();
        console.error("Error response text:", errData);
        throw new Error(`No se pudieron cargar las tiendas (${response.status})`);
    }
    ALL_STORES = await response.json();
    
    ACTIVE_STORE = ALL_STORES.find(s => s.name === 'jtl') || ALL_STORES.find(s => s.isPublic);
    
    if (!ACTIVE_STORE) {
      productsWrap.innerHTML = '<h2>No hay tiendas públicas disponibles en este momento.</h2>';
      return;
    }
    
    // Cargar productos de TODAS las tiendas
    products = [];
    for (const store of ALL_STORES) {
      const storeProducts = await loadProductsFor(store._id);
      products.push(...storeProducts);
    }
    
    renderHeader();
    renderProducts();
    renderCart();
    loadCategoryFilter();
    populateLoginStores();

  } catch (error) {
    console.error('Error fatal en initPublicUI:', error);
    productsWrap.innerHTML = `<h2>Error al cargar la aplicación: ${error.message}</h2><p>Asegúrate de que el servidor backend (${API_URL}) esté corriendo.</p>`;
  }
}

/* Cerrar panel admin */
document.getElementById('close-admin').onclick = async () => {
  adminPanel.style.display = 'none';
  LOGGED_IN_STORE = null;
  removeToken();
  await initPublicUI();
};

/* ---------- Inicialización final ---------- */
applyThemeFromStorage();
initPublicUI();

// --- ¡FIN DE LA CORRECCIÓN! ---
}); 
</script>

</body>
</html>
